

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>django_pewtils.__init__ &mdash; django_pewtils 1.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> django_pewtils
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../base.html">Basic functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../abstract_models.html">Abstract models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../managers.html">Managers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">django_pewtils</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>django_pewtils.__init__</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for django_pewtils.__init__</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">object</span>
<span class="kn">import</span> <span class="nn">shutil</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">importlib</span><span class="o">,</span> <span class="nn">pkgutil</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">imp</span><span class="o">,</span> <span class="nn">datetime</span><span class="o">,</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="k">import</span> <span class="n">closing</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>

<span class="kn">from</span> <span class="nn">pewtils</span> <span class="k">import</span> <span class="n">is_null</span><span class="p">,</span> <span class="n">is_not_null</span>
<span class="kn">from</span> <span class="nn">pewtils.io</span> <span class="k">import</span> <span class="n">FileHandler</span>

<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="k">import</span> <span class="n">ImproperlyConfigured</span><span class="p">,</span> <span class="n">AppRegistryNotReady</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">transaction</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">django.contrib.admin.utils</span> <span class="k">import</span> <span class="n">NestedObjects</span>
    <span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">DEFAULT_DB_ALIAS</span>
    <span class="kn">from</span> <span class="nn">django.apps</span> <span class="k">import</span> <span class="n">apps</span>
    <span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">IntegrityError</span>
    <span class="kn">from</span> <span class="nn">django.core.cache</span> <span class="k">import</span> <span class="n">cache</span>
    <span class="kn">from</span> <span class="nn">django.contrib.contenttypes.models</span> <span class="k">import</span> <span class="n">ContentType</span>
    <span class="kn">from</span> <span class="nn">django.db.models</span> <span class="k">import</span> <span class="n">Case</span><span class="p">,</span> <span class="n">When</span>
    <span class="kn">from</span> <span class="nn">django.contrib.postgres.search</span> <span class="k">import</span> <span class="n">SearchQuery</span><span class="p">,</span> <span class="n">SearchRank</span><span class="p">,</span> <span class="n">SearchVector</span>
<span class="k">except</span> <span class="p">(</span><span class="n">ImproperlyConfigured</span><span class="p">,</span> <span class="n">AppRegistryNotReady</span><span class="p">):</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="detect_primary_app"><a class="viewcode-back" href="../../base.html#django_pewtils.__init__.detect_primary_app">[docs]</a><span class="k">def</span> <span class="nf">detect_primary_app</span><span class="p">():</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attempts to detect the primary app by looking for `manage.py` and `settings.py`</span>

<span class="sd">    :return: The name of the primary app, if found</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">app_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s2">&quot;manage.py&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()):</span>
        <span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;manage.py&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">manage_file</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">manage_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">app_names</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[</span><span class="se">\&quot;</span><span class="s2">\&#39;]([^</span><span class="se">\&quot;</span><span class="s2">\&#39;]+)\.settings[</span><span class="se">\&quot;</span><span class="s2">\&#39;]&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">app_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
                <span class="n">app_name</span> <span class="o">=</span> <span class="n">app_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">app_name</span></div>


<div class="viewcode-block" id="load_app"><a class="viewcode-back" href="../../base.html#django_pewtils.__init__.load_app">[docs]</a><span class="k">def</span> <span class="nf">load_app</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets up a Django application to run outside of the Django shell. You can also pass this function a path to add to</span>
<span class="sd">    the `sys.path` and a dictionary of additional environment variables to add to `os.environ`. The function must</span>
<span class="sd">    be able to find a valid `app_name`.settings module to work.</span>

<span class="sd">    :param app_name: The name of the Django application (if not provided, will attempt to auto-detect)</span>
<span class="sd">    :type app_name: str</span>
<span class="sd">    :param path: Optional path to add to the Python path. Can be a list or string.</span>
<span class="sd">    :type path: str or list</span>
<span class="sd">    :param env: Optional dictionary of variables to add to `os.environ`</span>
<span class="sd">    :type env: dict</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">app_name</span><span class="p">:</span>
        <span class="n">app_name</span> <span class="o">=</span> <span class="n">detect_primary_app</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">app_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Couldn&#39;t detect the primary app, please provide the name in `app_name`.&quot;</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">env</span><span class="p">:</span>
        <span class="n">env</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">django</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">sys</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;DJANGO_SETTINGS_MODULE&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.settings&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">app_name</span><span class="p">))</span>
    <span class="n">django</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_model"><a class="viewcode-back" href="../../base.html#django_pewtils.__init__.get_model">[docs]</a><span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">app_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a Django model class via a string lookup. If the string that was passed in fails to match directly to a</span>
<span class="sd">    model, several variations will be tried that include lowercasing and removing or swapping out underscores and/or</span>
<span class="sd">    spaces. If the string matches to multiple models from different applications, the function will fail to return</span>
<span class="sd">    anything. You can provide an optional `app_name` to this function to deal with ambiguous cases.</span>

<span class="sd">    :param name: Name of the model</span>
<span class="sd">    :type name: str</span>
<span class="sd">    :param app_name: Name of the app</span>
<span class="sd">    :type app_name: str</span>
<span class="sd">    :return: Django model class</span>

<span class="sd">    Usage::</span>

<span class="sd">        from django_pewtils import get_model</span>

<span class="sd">        &gt;&gt; get_model(&quot;contenttype&quot;)</span>
<span class="sd">        django.contrib.contenttypes.models.ContentType</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
        <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
        <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">),</span>
        <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
        <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">),</span>
        <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">app_name</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">apps</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">LookupError</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">model_class</span><span class="p">()</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">except</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">MultipleObjectsReturned</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find a model named &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">app_name</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Try specifying the name of the app; there may be more than one model with this name&quot;</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span></div>


<div class="viewcode-block" id="reset_django_connection"><a class="viewcode-back" href="../../base.html#django_pewtils.__init__.reset_django_connection">[docs]</a><span class="k">def</span> <span class="nf">reset_django_connection</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Will reload a Django application and reset the database connection. If an `app_name` is not specified, it will</span>
<span class="sd">    search for it in `settings.SITE_NAME`.</span>

<span class="sd">    :param app_name: The name of the application to reload/reset (if not provided, will attempt to auto-detect)</span>
<span class="sd">    :type app_name: str</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">app_name</span><span class="p">:</span>
        <span class="n">app_name</span> <span class="o">=</span> <span class="n">detect_primary_app</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">app_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Couldn&#39;t detect the primary app, please provide the name in `app_name`.&quot;</span>
            <span class="p">)</span>
    <span class="n">load_app</span><span class="p">(</span><span class="n">app_name</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">connection</span>

    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="reset_django_connection_wrapper"><a class="viewcode-back" href="../../base.html#django_pewtils.__init__.reset_django_connection_wrapper">[docs]</a><span class="k">def</span> <span class="nf">reset_django_connection_wrapper</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator for `reset_django_connection`</span>

<span class="sd">    :param app_name: The name of the primary app (if not provided, will attempt to auto-detect)</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_reset_django_connection_wrapper</span><span class="p">(</span><span class="n">handle</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
            <span class="n">reset_django_connection</span><span class="p">(</span><span class="n">app_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wrapper</span>

    <span class="k">return</span> <span class="n">_reset_django_connection_wrapper</span></div>


<div class="viewcode-block" id="inspect_delete"><a class="viewcode-back" href="../../base.html#django_pewtils.__init__.inspect_delete">[docs]</a><span class="k">def</span> <span class="nf">inspect_delete</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">counts</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes a QuerySet and determines how deleting it would affect other objects in the database, accounting for</span>
<span class="sd">    cascades. Returns a dictionary where keys are each model in the database that will be affected, and the values</span>
<span class="sd">    are either QuerySets of the items that will be deleted (if `count=False`) or the number of records that will be</span>
<span class="sd">    deleted (if `count=True`).</span>

<span class="sd">    :param items: A Django QuerySet</span>
<span class="sd">    :param counts: Whether to return QuerySets or counts</span>
<span class="sd">    :return: A dictionary representing the objects in various tables that would be deleted</span>

<span class="sd">    Usage::</span>

<span class="sd">        &gt;&gt;&gt; inspect_delete(Politician.objects.filter(bioguide_id=&quot;S000033&quot;), counts=True)</span>
<span class="sd">        defaultdict(list,</span>
<span class="sd">                    {logos.models.agents.Politician: 1,</span>
<span class="sd">                     logos.models.agents.Politician_commands: 21,</span>
<span class="sd">                     logos.models.agents.Politician_command_logs: 1112,</span>
<span class="sd">                     logos.models.agents.PoliticianPersonalMetric: 47,</span>
<span class="sd">                     logos.models.agents.PoliticianPersonalMetric_commands: 27,</span>
<span class="sd">                     logos.models.agents.PoliticianPersonalMetric_command_logs: 167,</span>
<span class="sd">                     logos.models.media.NewsArticle_relevant_politicians: 96109,</span>
<span class="sd">                     logos.models.media.BallotpediaPage: 1,</span>
<span class="sd">                     logos.models.media.WikipediaPage: 1,</span>
<span class="sd">                     logos.models.media.WikipediaPage_commands: 1,</span>
<span class="sd">                     logos.models.media.WikipediaPage_command_logs: 1,</span>
<span class="sd">                     logos.models.government.CommitteeMembership: 63,</span>
<span class="sd">                     logos.models.government.CommitteeMembership_commands: 63,</span>
<span class="sd">                     logos.models.government.CommitteeMembership_command_logs: 63,</span>
<span class="sd">                     logos.models.government.Caucus_members: 1,</span>
<span class="sd">                     logos.models.government.Bill_cosponsors: 2638,</span>
<span class="sd">                     logos.models.government.Vote_votes_for: 3320,</span>
<span class="sd">                     logos.models.government.Vote_votes_against: 1918,</span>
<span class="sd">                     logos.models.government.Vote_votes_abstained: 343,</span>
<span class="sd">                     logos.models.government.LegislativeHearing_attendees: 1059})</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">collector</span> <span class="o">=</span> <span class="n">NestedObjects</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">DEFAULT_DB_ALIAS</span><span class="p">)</span>
    <span class="n">collector</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_collapse_results</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">to_delete</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">to_delete</span> <span class="o">=</span> <span class="n">_collapse_results</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">to_delete</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">to_delete</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">to_delete</span>

    <span class="n">to_delete</span> <span class="o">=</span> <span class="n">_collapse_results</span><span class="p">(</span><span class="n">collector</span><span class="o">.</span><span class="n">nested</span><span class="p">(),</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">to_delete</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">counts</span><span class="p">:</span>
            <span class="n">to_delete</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">ids</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">to_delete</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">ids</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">to_delete</span></div>


<div class="viewcode-block" id="filter_field_dict"><a class="viewcode-back" href="../../base.html#django_pewtils.__init__.filter_field_dict">[docs]</a><span class="k">def</span> <span class="nf">filter_field_dict</span><span class="p">(</span>
    <span class="nb">dict</span><span class="p">,</span> <span class="n">drop_nulls</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">empty_lists_are_null</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">drop_underscore_joins</span><span class="o">=</span><span class="kc">True</span>
<span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A utility function that clears out the contents of a dictionary based on boolean toggles.</span>

<span class="sd">    :param dict: Dictionary of values to prune</span>
<span class="sd">    :param drop_nulls: If True (default=True), keys with null values are deleted (using utils.is_null())</span>
<span class="sd">    :param empty_lists_are_null: If True (default=False), empty lists are considered null</span>
<span class="sd">    :param drop_underscore_joins: If True (default=True), keys that contain &quot;__&quot; are dropped</span>
<span class="sd">    :return: The pruned dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">drop_underscore_joins</span> <span class="ow">and</span> <span class="s2">&quot;__&quot;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="n">drop_nulls</span>
                <span class="ow">and</span> <span class="n">is_null</span><span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">empty_lists_are_null</span><span class="o">=</span><span class="n">empty_lists_are_null</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">del</span> <span class="nb">dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;content_object&quot;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="nb">dict</span><span class="p">[</span><span class="s2">&quot;content_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_for_model</span><span class="p">(</span>
                <span class="nb">dict</span><span class="p">[</span><span class="s2">&quot;content_object&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="nb">dict</span><span class="p">[</span><span class="s2">&quot;object_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="s2">&quot;content_object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pk</span>
            <span class="k">del</span> <span class="nb">dict</span><span class="p">[</span><span class="s2">&quot;content_object&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="nb">dict</span></div>


<div class="viewcode-block" id="field_exists"><a class="viewcode-back" href="../../base.html#django_pewtils.__init__.field_exists">[docs]</a><span class="k">def</span> <span class="nf">field_exists</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks whether a field exists on a model</span>

<span class="sd">    :param model: The model class to check</span>
<span class="sd">    :param field: The name of the field</span>
<span class="sd">    :return: True if the field exists on the model, else False</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">get_all_field_names</span><span class="p">(</span><span class="n">model</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_all_field_names"><a class="viewcode-back" href="../../base.html#django_pewtils.__init__.get_all_field_names">[docs]</a><span class="k">def</span> <span class="nf">get_all_field_names</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of all field names on a given model.</span>

<span class="sd">    :param model: A Django model class</span>
<span class="sd">    :return: List of field names</span>

<span class="sd">    Usage::</span>

<span class="sd">        from django_pewtils import get_all_field_names</span>

<span class="sd">        &gt;&gt;&gt; get_all_field_names(Politician)</span>
<span class="sd">        [&#39;id&#39;, &#39;first_name&#39;, &#39;nickname&#39;, &#39;last_name&#39;, &#39;fec_ids&#39;, &#39;bioguide_id&#39;, &#39;icpsr_ids&#39;, &#39;instagram_ids&#39;]</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span>
        <span class="nb">set</span><span class="p">(</span>
            <span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span>
                <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">attname</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s2">&quot;attname&quot;</span><span class="p">)</span>
                <span class="k">else</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,)</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_fields</span><span class="p">()</span>
                <span class="c1"># For complete backwards compatibility, you may want to exclude</span>
                <span class="c1"># GenericForeignKey from the results.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">many_to_one</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">related_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="AmbiguousConsolidationError"><a class="viewcode-back" href="../../base.html#django_pewtils.__init__.AmbiguousConsolidationError">[docs]</a><span class="k">class</span> <span class="nc">AmbiguousConsolidationError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exception that gets raised when `consolidate_objects` cannot determine how to collapse dependent objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">pass</span></div>


<div class="viewcode-block" id="ConsolidationCascadeError"><a class="viewcode-back" href="../../base.html#django_pewtils.__init__.ConsolidationCascadeError">[docs]</a><span class="k">class</span> <span class="nc">ConsolidationCascadeError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exception that gets raise when `consolidate_objects` must collapse related objects and</span>
<span class="sd">    `consolidate_related_uniques` is not enabled</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">pass</span></div>


<div class="viewcode-block" id="consolidate_objects"><a class="viewcode-back" href="../../base.html#django_pewtils.__init__.consolidate_objects">[docs]</a><span class="k">def</span> <span class="nf">consolidate_objects</span><span class="p">(</span>
    <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">consolidate_related_uniques</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A function for merging two objects from the same model into a single object; extremely useful for de-duplicating.</span>
<span class="sd">    Because the effects of this function cannot be reversed, the required parameters `source` and `target` are</span>
<span class="sd">    defined as keyword arguments to make things very explicit, but the function will raise an error if you do not</span>
<span class="sd">    provide both. The function will loop over all fields and relations on the source and if the field or relation on</span>
<span class="sd">    the target object is null, it will set the value to that of the source object. If the field or relation is already</span>
<span class="sd">    set and it can only take one value (e.g. a foreign key) then it will only update the target object with the source</span>
<span class="sd">    object&#39;s value if `overwrite` is set to `True`; by default, it will preserve any values on the target object.</span>
<span class="sd">    For many-to-many fields, any objects related to the source but not the target will be added to the target&#39;s</span>
<span class="sd">    existing relations. Postgres ArrayFields are also addressed in such a manner. Any objects that are related to the</span>
<span class="sd">    source will have their relations redirected to the target. Self-references on the source will also obviously be</span>
<span class="sd">    redirected at the target since the objects are being merged. In cases where there are conflicting unique relations</span>
<span class="sd">    (e.g. source and target have two different unique one-to-one relationships with other objects, or a merge will</span>
<span class="sd">    result in a unique_together constraint being violated), this function has the ability to recursively cascade to</span>
<span class="sd">    those relationships and consolidate dependent relations. That is, the conflicting related objects will be merged</span>
<span class="sd">    first, prior to merging the primary source and target. Since this behavior might be unexpected, the function raises</span>
<span class="sd">    an error by default and provides information on the additional objects that will be consolidated. To proceed with</span>
<span class="sd">    the merge, `consolidate_related_uniques` must be set to `True`. If this cascading merge behavior runs into a</span>
<span class="sd">    situation where a dependent pair has additional conflicting relationships with other objects outside of the</span>
<span class="sd">    original source and target, it will be unclear which value to preserve and which to overwrite, so the function</span>
<span class="sd">    will raise an error. For example, if your original objects A and B have one-to-ones with objects C and D, if</span>
<span class="sd">    cascading is enabled then C will be merged with D using the behavior selected via `overwrite`. However, if C and D</span>
<span class="sd">    in turn have foreign key or one-to-one relationships with other objects that are NOT A and B themselves, since</span>
<span class="sd">    these relations cannot be merged into a union (as with a many-to-many), it will be ambiguous as to which relation</span>
<span class="sd">    to preserve and which to overwrite, so the merge will be aborted.</span>

<span class="sd">    NOTE ON COMPLEX RELATIONS: this function has not been tested on all possible database schema and if your objects</span>
<span class="sd">    have many different relationships with varying unique constraints, it may behave in unexpected ways. You should</span>
<span class="sd">    expect that related object relations will be redirected to the target and objects that are related to the source</span>
<span class="sd">    will have those relations set to null unless `overwrite` is `True`. If `consolidate_related_uniques` is `True`,</span>
<span class="sd">    other objects may also be merged, and if any ambiguous merging situations are encountered, the function will</span>
<span class="sd">    do its best to detect them and abort the merge so that you can handle the dependent merges explicitly as you</span>
<span class="sd">    choose. Generally speaking, you can expect that the only properties of related objects that will change will be the</span>
<span class="sd">    relations those objects have to the source/target objects themselves, or non-relation values that will be</span>
<span class="sd">    consolidated according to `overwrite` when `consolidate_related_uniques` is enabled and there are otherwise no</span>
<span class="sd">    conflicts between the two objects. But if you have complex model relations and are unsure how this function will</span>
<span class="sd">    operate, it is best to perform dependent merges manually so you can monitor and control the behavior.</span>

<span class="sd">    NOTE ON NON-NULLABLE RELATIONS: When `consolidate_related_uniques` is `True`, some relationships will have to be</span>
<span class="sd">    temporarily set to null for merges to be performed successfully. If your unique relations are not nullable then</span>
<span class="sd">    errors will likely occur.</span>

<span class="sd">    NOTE ON TRANSACTIONS: This entire function is wrapped in a transaction; if an error occurs the entire operation</span>
<span class="sd">    will be safely rolled back.</span>

<span class="sd">    :param source: The object to merge into the target (to be deleted)</span>
<span class="sd">    :param target: The object to preserve (and optionally update)</span>
<span class="sd">    :param overwrite: Whether or not to overwrite existing non-null values on the target with values from the source</span>
<span class="sd">    :param consolidate_related_uniques: If conflicting unique relationships (like one-to-ones) exist, attempt to</span>
<span class="sd">    consolidate the conflicting objects in addition to the source and target (if there are additional relations that</span>
<span class="sd">    must be collapsed, then an error will be raised.) If dependent relations exist and this is not set to `True`, then</span>
<span class="sd">    an error will be raised.</span>
<span class="sd">    :return: The remaining target object</span>

<span class="sd">    Usage::</span>

<span class="sd">        from django_pewtils import consolidate_objects</span>

<span class="sd">        consolidate_objects(</span>
<span class="sd">            source=duplicate_obj,</span>
<span class="sd">            target=obj,</span>
<span class="sd">            overwrite=False,  # False means that we&#39;ll prefer preserving the target&#39;s existing values if we encounter conflicts</span>
<span class="sd">            consolidate_related_uniques=False  # Unless we set this to True, the function will raise an error if there are conflicting relationships that can&#39;t be merged</span>
<span class="sd">        )</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">source</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;You must provide a source and a target&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">source</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model</span> <span class="o">!=</span> <span class="n">target</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The two objects must belong to the same model class&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="c1"># Make a note of the &quot;final&quot; source and target</span>
        <span class="n">main_source</span> <span class="o">=</span> <span class="n">source</span>
        <span class="n">main_target</span> <span class="o">=</span> <span class="n">target</span>

        <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>

            <span class="c1"># Get any dependencies</span>
            <span class="n">new_obj_mapper</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
            <span class="n">pairs</span> <span class="o">=</span> <span class="n">_get_unique_relations</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>

            <span class="c1"># If there are cascades and you haven&#39;t specified that cascading consolidation should occur, raise an error</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">consolidate_related_uniques</span><span class="p">:</span>
                <span class="n">additional_uniques</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pairs</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">source</span><span class="p">]</span>
                <span class="k">raise</span> <span class="n">ConsolidationCascadeError</span><span class="p">(</span>
                    <span class="s2">&quot;Consolidating these objects will require the merging of additional objects due to unique &quot;</span>
                    <span class="s2">&quot;relation constraints: </span><span class="si">{}</span><span class="s2">.</span><span class="se">\n</span><span class="s2"> To continue with the consolidation process, please set &quot;</span>
                    <span class="s2">&quot;`consolidate_related_uniques` to True.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">additional_uniques</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="n">delayed_updates</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># Loop over all of the pairs that need to be collapsed</span>
            <span class="k">for</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>

                <span class="c1"># If any of the objects have already been consolidated and updated, then we need to</span>
                <span class="c1"># update our references to the new objects</span>
                <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">pk</span> <span class="ow">in</span> <span class="n">new_obj_mapper</span><span class="p">[</span><span class="n">source</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">source</span> <span class="o">=</span> <span class="n">new_obj_mapper</span><span class="p">[</span><span class="n">source</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model</span><span class="p">][</span><span class="n">source</span><span class="o">.</span><span class="n">pk</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">pk</span> <span class="ow">in</span> <span class="n">new_obj_mapper</span><span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="n">new_obj_mapper</span><span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model</span><span class="p">][</span><span class="n">target</span><span class="o">.</span><span class="n">pk</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">source</span> <span class="o">!=</span> <span class="n">target</span><span class="p">:</span>

                    <span class="c1"># Just to be sure that we have the absolute most up-to-date objects, we&#39;ll refresh from the DB</span>
                    <span class="n">source</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>
                    <span class="n">target</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>

                    <span class="n">fields</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_fields</span><span class="p">()</span>

                    <span class="c1"># If we&#39;re currently doing a cascaded consolidation, we need to check for potential issues</span>
                    <span class="k">if</span> <span class="n">source</span> <span class="o">!=</span> <span class="n">main_source</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                            <span class="c1"># For each foreign key or one-to-one field, if there are conflicting values and one or both</span>
                            <span class="c1"># of them aren&#39;t being explicitly tracked by the consolidation process as a source or target</span>
                            <span class="c1"># then it&#39;s unclear which one to pick to keep and which one to clear. Accordingly, we&#39;ll</span>
                            <span class="c1"># raise an error and force you to handle the merge `overwrite` behavior yourself.</span>
                            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">one_to_one</span> <span class="ow">or</span> <span class="n">f</span><span class="o">.</span><span class="n">many_to_one</span><span class="p">:</span>
                                <span class="c1"># If the values aren&#39;t the same and they don&#39;t both point to objects that are</span>
                                <span class="c1"># themselves getting merged, then we don&#39;t know what to do here and we&#39;re going to yell.</span>
                                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">getattr</span><span class="p">(</span>
                                    <span class="n">target</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span>
                                <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                                    <span class="p">(</span>
                                        <span class="nb">getattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                                        <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">]</span>
                                        <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                                        <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">]</span>
                                    <span class="p">)</span>
                                    <span class="ow">or</span> <span class="p">(</span>
                                        <span class="nb">getattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                                        <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">]</span>
                                        <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                                        <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">]</span>
                                    <span class="p">)</span>
                                <span class="p">):</span>
                                    <span class="k">raise</span> <span class="n">AmbiguousConsolidationError</span><span class="p">(</span>
                                        <span class="s2">&quot;(</span><span class="si">{}</span><span class="s2"> -&gt; </span><span class="si">{}</span><span class="s2">) consolidation cascaded to (</span><span class="si">{}</span><span class="s2"> -&gt; </span><span class="si">{}</span><span class="s2">), but these objects have &quot;</span>
                                        <span class="s2">&quot;conflicting &#39;</span><span class="si">{}</span><span class="s2">&#39; relations (</span><span class="si">{}</span><span class="s2"> vs </span><span class="si">{}</span><span class="s2">) and it&#39;s unclear &quot;</span>
                                        <span class="s2">&quot;should be preserved. Please consolidate the dependent pair manually and &quot;</span>
                                        <span class="s2">&quot;specify `overwrite`.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                            <span class="n">main_source</span><span class="p">,</span>
                                            <span class="n">main_target</span><span class="p">,</span>
                                            <span class="n">source</span><span class="p">,</span>
                                            <span class="n">target</span><span class="p">,</span>
                                            <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                            <span class="nb">getattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                                            <span class="nb">getattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                                        <span class="p">)</span>
                                    <span class="p">)</span>

                    <span class="c1"># Loop over all fields on the model</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">is_relation</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">primary_key</span><span class="p">:</span>
                            <span class="c1"># If it&#39;s not a relation</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
                                <span class="nb">getattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="nb">list</span>
                            <span class="p">):</span>
                                <span class="c1"># If it&#39;s a list, then set the new value to the union</span>
                                <span class="nb">setattr</span><span class="p">(</span>
                                    <span class="n">target</span><span class="p">,</span>
                                    <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                    <span class="nb">list</span><span class="p">(</span>
                                        <span class="nb">set</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">))</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
                                            <span class="nb">set</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                                        <span class="p">)</span>
                                    <span class="p">),</span>
                                <span class="p">)</span>
                            <span class="k">elif</span> <span class="p">(</span>
                                <span class="n">is_null</span><span class="p">(</span>
                                    <span class="nb">getattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">empty_lists_are_null</span><span class="o">=</span><span class="kc">True</span>
                                <span class="p">)</span>
                                <span class="ow">or</span> <span class="n">overwrite</span>
                            <span class="p">):</span>
                                <span class="c1"># Otherwise, it&#39;s a normal value</span>
                                <span class="c1"># If overwrite is True and the value on source isn&#39;t null</span>
                                <span class="c1"># then we&#39;ll update the target object</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">primary_key</span><span class="p">:</span>
                                    <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">unique</span><span class="p">:</span>
                                        <span class="c1"># If it&#39;s a unique value, we need to clear out the value on source</span>
                                        <span class="nb">setattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                                        <span class="n">source</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                                    <span class="nb">setattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">one_to_one</span> <span class="ow">or</span> <span class="n">f</span><span class="o">.</span><span class="n">many_to_one</span><span class="p">:</span>
                            <span class="c1"># If it&#39;s a one-to-one or foreign key</span>
                            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                                <span class="n">is_null</span><span class="p">(</span>
                                    <span class="nb">getattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">empty_lists_are_null</span><span class="o">=</span><span class="kc">True</span>
                                <span class="p">)</span>
                                <span class="ow">or</span> <span class="n">overwrite</span>
                            <span class="p">):</span>
                                <span class="c1"># If the value on target is null, or we&#39;re overwriting</span>
                                <span class="k">if</span> <span class="p">(</span>
                                    <span class="n">is_not_null</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
                                    <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                                    <span class="ow">and</span> <span class="n">is_not_null</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                                <span class="p">):</span>
                                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">concrete</span><span class="p">:</span>
                                        <span class="c1"># If the relation is on the source/target model</span>
                                        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="n">source</span><span class="p">:</span>
                                            <span class="c1"># If it&#39;s a self-reference, then update it to target</span>
                                            <span class="nb">setattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="c1"># Otherwise, set it to whatever is on the source</span>
                                            <span class="nb">setattr</span><span class="p">(</span>
                                                <span class="n">target</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                                            <span class="p">)</span>
                                        <span class="c1"># Clear out the source relation</span>
                                        <span class="nb">setattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                                        <span class="n">source</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="c1"># In this case, the relation is stored on the related model</span>
                                        <span class="c1"># Since there could be conflicts if we&#39;re doing cascading merges, we&#39;ll clear</span>
                                        <span class="c1"># it out and then circle back at the end and set it to the proper value</span>
                                        <span class="n">related_object</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                                        <span class="nb">setattr</span><span class="p">(</span>
                                            <span class="n">related_object</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span>
                                        <span class="p">)</span>
                                        <span class="n">delayed_updates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                            <span class="p">(</span>
                                                <span class="n">related_object</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                                <span class="n">related_object</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
                                                <span class="n">f</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                <span class="n">target</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                                <span class="n">target</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
                                            <span class="p">)</span>
                                        <span class="p">)</span>
                                        <span class="n">related_object</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                        <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">one_to_many</span><span class="p">:</span>

                            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;object_id_field_name&quot;</span><span class="p">):</span>
                                <span class="c1"># In this case, it&#39;s a generic relation</span>
                                <span class="n">pk_field</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">object_id_field_name</span>
                                <span class="k">for</span> <span class="n">related_object</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                                    <span class="nb">setattr</span><span class="p">(</span><span class="n">related_object</span><span class="p">,</span> <span class="n">pk_field</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
                                    <span class="n">related_object</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># Otherwise, we&#39;re just updating the related object and redirecting the foreign key</span>
                                <span class="c1"># to the new target object</span>
                                <span class="k">for</span> <span class="n">related_object</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                                    <span class="nb">setattr</span><span class="p">(</span><span class="n">related_object</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
                                    <span class="n">related_object</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                        <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">many_to_many</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;through&quot;</span><span class="p">):</span>
                                <span class="n">through</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">through</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">through</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">through</span>
                            <span class="k">if</span> <span class="p">(</span>
                                <span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">auto_created</span>
                                <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                                <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                            <span class="p">):</span>
                                <span class="c1"># If it&#39;s a many-to-many object, we&#39;ll set the target&#39;s M2M relation to the union</span>
                                <span class="c1"># If there&#39;s a custom through table, those foreign key relations will appear as FKs</span>
                                <span class="c1"># And will be updated separately</span>
                                <span class="n">merged_objects</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="nb">getattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                                    <span class="o">|</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                                <span class="p">)</span>
                                <span class="nb">getattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">merged_objects</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s2">&quot;history&quot;</span><span class="p">):</span>
                        <span class="c1"># If you have a django-historical-records manager installed on the model, we&#39;ll update the</span>
                        <span class="c1"># historical records</span>
                        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                            <span class="n">h</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">pk</span>
                            <span class="n">h</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                    <span class="c1"># Save the new target in the map so we can update any downstream references to the old source</span>
                    <span class="n">new_obj_mapper</span><span class="p">[</span><span class="n">source</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model</span><span class="p">][</span><span class="n">source</span><span class="o">.</span><span class="n">pk</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Attempt to save the target before deleting the source, just to be safe, but if there&#39;s a</span>
                        <span class="c1"># unique constraint collision, the source needs to go before the target is saved</span>
                        <span class="n">target</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                        <span class="n">source</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                    <span class="k">except</span> <span class="n">IntegrityError</span><span class="p">:</span>
                        <span class="n">source</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                        <span class="n">target</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                    <span class="n">target</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>

            <span class="c1"># Now we&#39;ll loop over any relations that weren&#39;t updated due to conflicts and make sure everything is</span>
            <span class="c1"># set to what it should be</span>
            <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">val_model</span><span class="p">,</span> <span class="n">val_pk</span> <span class="ow">in</span> <span class="n">delayed_updates</span><span class="p">:</span>
                <span class="c1"># First we&#39;ll get the object and related object and pass them through the mapper in case they were</span>
                <span class="c1"># merged into new objects. If not, we&#39;ll fetch them directly from the model.</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">new_obj_mapper</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">obj</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">model</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                        <span class="n">obj</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find object: </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">pk</span><span class="p">))</span>
                <span class="n">val_obj</span> <span class="o">=</span> <span class="n">new_obj_mapper</span><span class="p">[</span><span class="n">val_model</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">val_pk</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">val_obj</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">val_obj</span> <span class="o">=</span> <span class="n">val_model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">val_pk</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">val_model</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                        <span class="n">val_obj</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">val_obj</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                            <span class="s2">&quot;Couldn&#39;t find object: </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val_model</span><span class="p">,</span> <span class="n">val_pk</span><span class="p">)</span>
                        <span class="p">)</span>
                <span class="c1"># Now we&#39;ll set the relation to its correct value</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>
                <span class="n">val_obj</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">val_obj</span><span class="p">)</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="c1"># And we&#39;re done!</span>
            <span class="n">target</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">target</span></div>


<span class="k">def</span> <span class="nf">_get_unique_relations</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">pairs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recursion</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An internal helper function for `consolidate_objects` that takes a source and target object, and recursively</span>
<span class="sd">    loops over their relations to find any related objects that have unique constraints that would raise a conflict if</span>
<span class="sd">    the source and target objects were merged. For example, a one-to-one relationship between source and object A, and</span>
<span class="sd">    target and object B; in such a case, object A and object B cannot both be related to target, so they too must be</span>
<span class="sd">    merged. This additional merge, in turn, may result in the need for yet more merging, hence the need for recursion.</span>

<span class="sd">    :param source: The object to be collapsed into target</span>
<span class="sd">    :param target: The target object to be preserved/updated</span>
<span class="sd">    :param pairs: Recursive parameter to track pairs that have already been detected</span>
<span class="sd">    :param recursion: The level of recursion (used for sorting prior to returning the final list)</span>
<span class="sd">    :return: A list of (source, target) tuples indicating pairs of objects that must be merged in order for the</span>
<span class="sd">    first merge to be successful</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">pairs</span><span class="p">:</span>
        <span class="c1"># Initialize a dictionary with the original pair and recursion level 0</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="p">{(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span> <span class="mi">0</span><span class="p">}</span>
    <span class="n">source_rels</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">related_objects</span><span class="p">()</span>
    <span class="n">target_rels</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">related_objects</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="n">target</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
        <span class="c1"># Loop over all relations on the source/target model</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_fields</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">source_rels</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">target_rels</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c1"># If the relation exists in both the source and target</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">one_to_one</span> <span class="ow">or</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">many_to_one</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">unique</span><span class="p">))</span>
                    <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">is_not_null</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="ow">and</span> <span class="n">is_not_null</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="p">):</span>
                    <span class="c1"># And if it&#39;s a one-to-one or unique foreign key and both objects have a value</span>
                    <span class="n">pair</span> <span class="o">=</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">pair</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pairs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="c1"># And the pair of related objects haven&#39;t yet been identified</span>
                        <span class="c1"># Then check them for unique relation conflicts as well</span>
                        <span class="n">pairs</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">=</span> <span class="n">recursion</span>
                        <span class="n">pairs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                            <span class="n">_get_unique_relations</span><span class="p">(</span>
                                <span class="o">*</span><span class="n">pair</span><span class="p">,</span> <span class="n">pairs</span><span class="o">=</span><span class="n">pairs</span><span class="p">,</span> <span class="n">recursion</span><span class="o">=</span><span class="n">recursion</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">one_to_many</span><span class="p">:</span>
                    <span class="c1"># Otherwise, if it&#39;s a foreign key on another model - and it&#39;s possible that the current source</span>
                    <span class="c1"># object could be party of a unique_together constraint, so we need to check for that</span>

                    <span class="c1"># First, let&#39;s gather up any unique_together constraints on the related model</span>
                    <span class="n">unique_togethers</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">fieldset</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">unique_together</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">fieldset</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fieldset</span><span class="p">:</span>
                                <span class="n">unique_togethers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">unique_togethers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fieldset</span><span class="p">)</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">remote_field</span><span class="p">,</span> <span class="s2">&quot;unique&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">unique</span>
                    <span class="p">)</span> <span class="ow">or</span> <span class="n">f</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">unique_togethers</span><span class="p">:</span>
                        <span class="c1"># If the relation itself is part of the related model&#39;s uniqueness (either by being explicitly</span>
                        <span class="c1"># flagged as such, or by being a part of a unique_together constraint, then let&#39;s see if there are</span>
                        <span class="c1"># any related objects that are identical except for their link to source vs target</span>
                        <span class="n">other_unique_fields</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">other</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_fields</span><span class="p">():</span>
                            <span class="c1"># First let&#39;s loop over all of the other fields in the related model and get an exhaustive</span>
                            <span class="c1"># list of everything that makes the related model objects unique; we already know about</span>
                            <span class="c1"># THIS field and any unique_together conditions, but other fields might be unique too</span>
                            <span class="k">if</span> <span class="p">(</span>
                                <span class="n">other</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;id&quot;</span>
                                <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">f</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">name</span>
                                <span class="ow">and</span> <span class="p">(</span>
                                    <span class="p">(</span>
                                        <span class="nb">hasattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="s2">&quot;unique&quot;</span><span class="p">)</span>
                                        <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">unique</span>
                                        <span class="ow">and</span> <span class="ow">not</span> <span class="n">other</span><span class="o">.</span><span class="n">one_to_one</span>
                                    <span class="p">)</span>
                                    <span class="ow">or</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">unique_togethers</span>
                                <span class="p">)</span>
                            <span class="p">):</span>
                                <span class="n">other_unique_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                        <span class="n">target_objs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">target_objs</span><span class="p">:</span>
                            <span class="c1"># Now we&#39;re going to loop over every single object that&#39;s linked to the target, to</span>
                            <span class="c1"># see if there&#39;s any overlap with those linked to source - related objects that are</span>
                            <span class="c1"># identical in uniqueness except for being linked to source vs. target</span>
                            <span class="n">source_objs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                            <span class="k">for</span> <span class="n">other</span> <span class="ow">in</span> <span class="n">other_unique_fields</span><span class="p">:</span>
                                <span class="n">source_objs</span> <span class="o">=</span> <span class="n">source_objs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                                    <span class="o">**</span><span class="p">{</span><span class="n">other</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">other</span><span class="p">)}</span>
                                <span class="p">)</span>
                            <span class="n">alt_source_objs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                            <span class="k">for</span> <span class="n">other</span> <span class="ow">in</span> <span class="n">unique_togethers</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">other</span> <span class="o">!=</span> <span class="n">f</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                                    <span class="n">alt_source_objs</span> <span class="o">=</span> <span class="n">alt_source_objs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                                        <span class="o">**</span><span class="p">{</span><span class="n">other</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">other</span><span class="p">)}</span>
                                    <span class="p">)</span>
                            <span class="n">source_objs</span> <span class="o">=</span> <span class="n">source_objs</span> <span class="o">|</span> <span class="n">alt_source_objs</span>
                            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">source_objs</span><span class="p">:</span>
                                <span class="c1"># If there are any objects related to source that will conflict with objects related to</span>
                                <span class="c1"># the target if the foreign key is changed, then we need to consolidate those too</span>
                                <span class="n">pair</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">pair</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pairs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                    <span class="c1"># So if it&#39;s a pairing we haven&#39;t seen, let&#39;s recursively check it too</span>
                                    <span class="n">pairs</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">=</span> <span class="n">recursion</span>
                                    <span class="n">pairs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                                        <span class="n">_get_unique_relations</span><span class="p">(</span>
                                            <span class="o">*</span><span class="n">pair</span><span class="p">,</span> <span class="n">pairs</span><span class="o">=</span><span class="n">pairs</span><span class="p">,</span> <span class="n">recursion</span><span class="o">=</span><span class="n">recursion</span> <span class="o">+</span> <span class="mi">1</span>
                                        <span class="p">)</span>
                                    <span class="p">)</span>

    <span class="k">if</span> <span class="n">recursion</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># If we&#39;ve finally rolled back up to the top level, let&#39;s sort all of the pairs we identified in the order</span>
        <span class="c1"># in which we identified them, and return a list</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pairs</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pairs</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">source</span><span class="p">]</span>
        <span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">pairs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Otherwise we&#39;re still in recursion and we&#39;ll keep the pairs in dictionary form</span>
        <span class="k">return</span> <span class="n">pairs</span>


<span class="k">class</span> <span class="nc">CacheHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">use_database</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A wrapper around `pewtils.io.FileHandler` that also has the ability to use Django&#39;s built-in database caching.</span>

<span class="sd">        :param path: The folder path to store cache data. If the database is used, this will serve as a key prefix.</span>
<span class="sd">        :param use_database: Whether or not to use the Django database caching or a cache folder via `FileHandler`.</span>
<span class="sd">        :param hash: Whether or not to hash the keys.</span>
<span class="sd">        :param options: Additional options for the `FileHandler` (like using S3 vs a local folder)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_handler</span> <span class="o">=</span> <span class="n">FileHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_database</span> <span class="o">=</span> <span class="n">use_database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hash</span> <span class="o">=</span> <span class="nb">hash</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_database</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cached_keys</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a value to the cache.</span>

<span class="sd">        :param key: The key to use to look up the stored value.</span>
<span class="sd">        :param value: The value to save to the cache.</span>
<span class="sd">        :param timeout: Optional timeout for the key to expire. Default is 5 minutes for database caching, and None for</span>
<span class="sd">        file-based caching.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_database</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_handler</span><span class="o">.</span><span class="n">get_key_hash</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">key</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cached_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="n">timeout</span> <span class="o">=</span> <span class="mf">60.0</span> <span class="o">*</span> <span class="mf">5.0</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;Database caching requires a timeout, but none was provided. Setting expiration at 5 minutes.&quot;</span>
                <span class="p">)</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                <span class="s2">&quot;timeout&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">timeout</span>
                <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_handler</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">hash_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;pkl&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read a value from the cache.</span>

<span class="sd">        :param key: The key to use to look up the stored value.</span>
<span class="sd">        :return: The stored value from the cache.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_database</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_handler</span><span class="o">.</span><span class="n">get_key_hash</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">key</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_handler</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">hash_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;pkl&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;timeout&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;timeout&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">clear_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear out all keys currently in the cache. If you are using the database, only values that have been</span>
<span class="sd">        stored by this `CacheHandler` instance will be cleared out. Otherwise, the whole folder path will be removed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_database</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Warning: only keys that have been set by this CacheHandler instance will be cleared&quot;</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cached_keys</span><span class="p">:</span>
                <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_handler</span><span class="o">.</span><span class="n">use_s3</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_handler</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bucket_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_handler</span><span class="o">.</span><span class="n">s3</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">file_handler</span><span class="o">.</span><span class="n">s3</span><span class="o">.</span><span class="n">delete_keys</span><span class="p">([</span><span class="n">key</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">bucket_list</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">clear_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear a specific key from the cache.</span>

<span class="sd">        :param key: The key to clear out.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_database</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_handler</span><span class="o">.</span><span class="n">get_key_hash</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">key</span><span class="p">])</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_handler</span><span class="o">.</span><span class="n">clear_file</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">hash_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;pkl&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="get_app_settings_folders"><a class="viewcode-back" href="../../base.html#django_pewtils.__init__.get_app_settings_folders">[docs]</a><span class="k">def</span> <span class="nf">get_app_settings_folders</span><span class="p">(</span><span class="n">settings_dir_list_var</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used to identify multiple values of a Django setting that are spread across multiple apps. Assumes that your</span>
<span class="sd">    primary app is the only one with a `settings.py` file, that it contains a setting whose value is a list, and that</span>
<span class="sd">    other apps may also set values for that setting in their app configuration, which may contain additional values in</span>
<span class="sd">    a list. For example, `django_learning` has a default set of dataset extractors, but also allows you to create your</span>
<span class="sd">    own in your own app. In order for `django_learning` to identify your own custom extractors and make them accessible</span>
<span class="sd">    via `django_learning.utils.dataset_extractors`, it needs to know not only about its own folders but also the</span>
<span class="sd">    folders in your own app where you store your own custom extractors. By passing `DJANGO_LEARNING_DATASET_EXTRACTORS`</span>
<span class="sd">    into this function, any list of folder paths that you store in that variable on your own app will also be added to</span>
<span class="sd">    the folders stored for that setting by `django_learning` in its own app configuration. In theory this can be</span>
<span class="sd">    used to unify any list settings that are spread out across multiple apps, but its use so far has been for compiling</span>
<span class="sd">    lists of folder paths.</span>

<span class="sd">    :param settings_dir_list_var: The name of the setting that exists on your app (must be a list), which may also</span>
<span class="sd">    exist in the configuration of other installed apps.</span>
<span class="sd">    :return: The union of all values for this settings across all installed apps, including your own</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># In theory, installable Django apps aren&#39;t supposed to have settings.py files</span>
    <span class="c1"># So we can auto-detect the root project this way</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">apps</span><span class="o">.</span><span class="n">get_app_configs</span><span class="p">()</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">AppRegistryNotReady</span><span class="p">,</span> <span class="n">ImproperlyConfigured</span><span class="p">):</span>
        <span class="n">app_name</span> <span class="o">=</span> <span class="n">detect_primary_app</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">app_name</span><span class="p">:</span>
            <span class="n">load_app</span><span class="p">(</span><span class="n">app_name</span><span class="p">)</span>
            <span class="n">apps</span><span class="o">.</span><span class="n">get_app_configs</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Django is not set up and the primary app could not be detected&quot;</span>
            <span class="p">)</span>

    <span class="kn">from</span> <span class="nn">django.conf</span> <span class="k">import</span> <span class="n">settings</span>

    <span class="n">dirs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">settings_dir_list_var</span><span class="p">):</span>
        <span class="n">dirs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">settings_dir_list_var</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dirs</span><span class="p">))</span></div>


<div class="viewcode-block" id="run_partial_postgres_search"><a class="viewcode-back" href="../../base.html#django_pewtils.__init__.run_partial_postgres_search">[docs]</a><span class="k">def</span> <span class="nf">run_partial_postgres_search</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">min_rank</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assuming that you have Postgres&#39; Trigram Extension installed, this function will allow you to run a full text</span>
<span class="sd">    search on one or more text fields.</span>

<span class="sd">    This function allows for the use of trailing wildcards (`*`) but otherwise will only find exact matches. If</span>
<span class="sd">    multiple tokens are passed (separated by spaces) then it will consider these terms bound by an `AND` boolean</span>
<span class="sd">    operator.</span>

<span class="sd">    :param model: The model you want to search</span>
<span class="sd">    :param text: The search query (one or more terms, with optional suffix wildcards)</span>
<span class="sd">    :param fields: List of fields to search on the model</span>
<span class="sd">    :param max_results: Top N results you want to return</span>
<span class="sd">    :param min_rank: The minimum SearchRank value that results must have to be returned.</span>
<span class="sd">    :return: A QuerySet of results.</span>

<span class="sd">    Usage::</span>

<span class="sd">        from django_pewtils import run_partial_postgres_search</span>

<span class="sd">        &gt;&gt;&gt; run_partial_postgres_search(Politician, &quot;Dwayne Rock Johnson&quot;, (&quot;first_name&quot;, &quot;nickname&quot;, &quot;last_name&quot;))</span>
<span class="sd">        &lt;PoliticianManager [&lt;Politician: Dwayne &#39;The Rock&#39; Johnson&gt;, &#39;...(remaining elements truncated)...&#39;]&gt;</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[!\&#39;()|&amp;]&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot; &amp; &quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;:*&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">SearchQuery</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">vector</span> <span class="o">=</span> <span class="n">SearchVector</span><span class="p">(</span><span class="o">*</span><span class="n">fields</span><span class="p">)</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">rank</span><span class="o">=</span><span class="n">SearchRank</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">query</span><span class="p">))</span>
        <span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">rank__gt</span><span class="o">=</span><span class="n">min_rank</span><span class="p">)</span>
        <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-rank&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">distinct</span><span class="p">()[:</span><span class="n">max_results</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">sql</span><span class="p">,</span> <span class="n">sql_params</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_compiler</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">queryset</span><span class="o">.</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">as_sql</span><span class="p">()</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;plainto_tsquery&quot;</span><span class="p">,</span> <span class="s2">&quot;to_tsquery&quot;</span><span class="p">,</span> <span class="n">sql</span><span class="p">)</span>
    <span class="n">sql_params</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="s2">&quot;&#39;&#39;&quot;</span> <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">sql_params</span><span class="p">)])</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">sql_params</span><span class="p">)</span>
    <span class="n">pk_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">pk</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
    <span class="n">preserved</span> <span class="o">=</span> <span class="n">Case</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">When</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">,</span> <span class="n">then</span><span class="o">=</span><span class="n">pos</span><span class="p">)</span> <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">pk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pk_list</span><span class="p">)])</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">pk_list</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">preserved</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">queryset</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, Pew Research Center

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>